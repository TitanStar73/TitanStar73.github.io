<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor Workbench</title>

    <!-- PyScript Core -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2c2c2c;
            --text-color: #f0f0f0;
            --accent-color: #007bff;
            --border-color: #444;
            --processing-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.5s;
        }
        .loader.hidden { opacity: 0; pointer-events: none; }
        .loader p { font-size: 1.5em; margin-bottom: 20px; }
        #fullscreen-btn {
            padding: 15px 30px; font-size: 1.2em; cursor: pointer;
            background-color: var(--accent-color); color: white; border: none; border-radius: 8px;
            display: none; /* Hidden until Python is ready */
        }

        .main-container { display: flex; flex-direction: row; height: 100%; }

        #controls-panel {
            background-color: var(--panel-bg); padding: 20px; width: 280px;
            min-width: 250px; max-width: 600px; height: 100%;
            box-sizing: border-box; display: flex; flex-direction: column;
            flex-shrink: 0;
        }
        #controls-wrapper { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .apply-button-container {
            flex-shrink: 0; padding-top: 15px; margin-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        #resizer { width: 8px; background-color: #111; cursor: col-resize; flex-shrink: 0; }
        #resizer:hover { background-color: var(--accent-color); }

        #gallery {
            flex-grow: 1; padding: 20px; overflow-y: auto;
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 15px; align-content: start;
        }
        .gallery-header {
            grid-column: span 1; text-align: center; font-size: 1.5em;
            font-weight: bold; color: #ccc; margin-bottom: 10px;
        }
        .gallery-image-container { width: 100%; }
        .gallery-image-container img {
            width: 100%; height: auto; display: block;
            border-radius: 4px; background-color: #111;
        }

        .control-group { margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .control-group h3 { margin-top: 0; color: var(--accent-color); font-size: 1.1em; }
        .control { margin-bottom: 15px; }
        .control label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .control input[type="range"] { width: 100%; }
        .control .value-display { display: inline-block; margin-left: 10px; font-weight: bold; }
        #curve-container { background-color: #111; border-radius: 4px; border: 1px solid var(--border-color); touch-action: none; }
        .apply-btn {
            background-color: var(--accent-color); color: white; border: none;
            padding: 15px; border-radius: 8px; font-size: 1.2em; font-weight: bold;
            cursor: pointer; transition: background-color 0.2s; width: 100%;
        }
        .apply-btn:hover { background-color: #0056b3; }
        .apply-btn:disabled { background-color: var(--processing-color); color: white; cursor: not-allowed; }
    </style>
</head>

<body>
    <div id="loader" class="loader">
        <p id="loader-text">ðŸš€ Initializing Python Environment...</p>
        <button id="fullscreen-btn">Enter Fullscreen</button>
    </div>

    <div class="main-container">
        <div id="controls-panel">
            <div id="controls-wrapper">
                <h2>Controls</h2>
                <!-- All control groups -->
                <div class="control-group"><h3>1. Technical Corrections</h3>
                    <div class="control"><label for="TEMPERATURE">Temperature <span class="value-display" id="TEMPERATURE_val">0</span></label><input type="range" id="TEMPERATURE" min="-100" max="100" value="0" step="1"></div>
                    <div class="control"><label for="TINT">Tint <span class="value-display" id="TINT_val">0</span></label><input type="range" id="TINT" min="-100" max="100" value="0" step="1"></div>
                    <div class="control"><label for="EXPOSURE">Exposure <span class="value-display" id="EXPOSURE_val">0.05</span></label><input type="range" id="EXPOSURE" min="-1" max="1" value="0.05" step="0.01"></div>
                    <div class="control"><label for="CONTRAST">Contrast <span class="value-display" id="CONTRAST_val">1.1</span></label><input type="range" id="CONTRAST" min="0" max="3" value="1.1" step="0.01"></div>
                    <div class="control"><label for="SHADOWS">Shadows <span class="value-display" id="SHADOWS_val">0.1</span></label><input type="range" id="SHADOWS" min="-1" max="1" value="0.1" step="0.01"></div>
                    <div class="control"><label for="HIGHLIGHTS">Highlights <span class="value-display" id="HIGHLIGHTS_val">-0.15</span></label><input type="range" id="HIGHLIGHTS" min="-1" max="1" value="-0.15" step="0.01"></div>
                </div>
                <div class="control-group"><h3>2. Creative Grading</h3>
                    <div class="control"><label for="CLAHE_CLIP_LIMIT">Clarity <span class="value-display" id="CLAHE_CLIP_LIMIT_val">2.0</span></label><input type="range" id="CLAHE_CLIP_LIMIT" min="0" max="10" value="2.0" step="0.1"></div>
                    <div class="control"><label for="VIBRANCE">Vibrance <span class="value-display" id="VIBRANCE_val">0.2</span></label><input type="range" id="VIBRANCE" min="-1" max="1" value="0.2" step="0.01"></div>
                    <div class="control"><label for="SATURATION">Saturation <span class="value-display" id="SATURATION_val">1.1</span></label><input type="range" id="SATURATION" min="0" max="3" value="1.1" step="0.01"></div>
                    <div class="control"><label>Tone Curve</label><div id="curve-container"><svg id="tone-curve-svg" width="100%" height="150"></svg></div></div>
                </div>
                <div class="control-group"><h3>3. Final Effects</h3>
                    <div class="control"><label for="SHARPEN_AMOUNT">Sharpen Amount <span class="value-display" id="SHARPEN_AMOUNT_val">0.5</span></label><input type="range" id="SHARPEN_AMOUNT" min="0" max="3" value="0.5" step="0.01"></div>
                    <div class="control"><label for="SHARPEN_RADIUS_RELATIVE">Sharpen Radius <span class="value-display" id="SHARPEN_RADIUS_RELATIVE_val">1.2</span></label><input type="range" id="SHARPEN_RADIUS_RELATIVE" min="0.1" max="5" value="1.2" step="0.1"></div>
                    <div class="control"><label for="GLOW_STRENGTH">Glow Strength <span class="value-display" id="GLOW_STRENGTH_val">0</span></label><input type="range" id="GLOW_STRENGTH" min="0" max="1" value="0" step="0.01"></div>
                    <div class="control"><label for="GLOW_RADIUS">Glow Radius <span class="value-display" id="GLOW_RADIUS_val">21</span></label><input type="range" id="GLOW_RADIUS" min="1" max="101" value="21" step="2"></div>
                    <div class="control"><label for="GLOW_THRESHOLD">Glow Threshold <span class="value-display" id="GLOW_THRESHOLD_val">220</span></label><input type="range" id="GLOW_THRESHOLD" min="0" max="255" value="220" step="1"></div>
                    <div class="control"><label for="VIGNETTE_STRENGTH">Vignette <span class="value-display" id="VIGNETTE_STRENGTH_val">0.5</span></label><input type="range" id="VIGNETTE_STRENGTH" min="0" max="1" value="0.5" step="0.01"></div>
                </div>
            </div>
            <div class="apply-button-container">
                <button id="apply-button" class="apply-btn">Apply Changes</button>
            </div>
        </div>

        <div id="resizer"></div>
        <div id="gallery"></div>
    </div>
    
    <py-config>
        packages = ["opencv-python", "numpy", "scipy"]
    </py-config>

    <script type="py">
        import asyncio
        import base64
        import cv2
        import numpy as np
        from scipy.interpolate import CubicSpline
        from pyodide.http import pyfetch
        from pyodide.ffi import create_proxy
        from pyscript import document
        import js

        # --- All image processing functions are unchanged ---
        def convert_to_float(img): return img.astype(np.float32) / 255.0
        def convert_to_uint8(img): return np.clip(img * 255, 0, 255).astype(np.uint8)
        def adjust_temp_tint(img, temp, tint):
            if temp == 0 and tint == 0: return img
            lab = cv2.cvtColor(convert_to_uint8(img), cv2.COLOR_BGR2LAB)
            l, a, b = cv2.split(lab); a = a.astype(np.float32); b = b.astype(np.float32)
            a += tint / 2.0; b += temp / 2.0
            lab[:,:,1] = np.clip(a, 0, 255); lab[:,:,2] = np.clip(b, 0, 255)
            return convert_to_float(cv2.cvtColor(lab, cv2.COLOR_LAB2BGR))
        def adjust_exposure_contrast(img, e, c): return np.clip(img * c + (0.5 * (1-c)) + e, 0, 1)
        def adjust_tonal_ranges(img, s, h):
            if s == 0 and h == 0: return img
            lab = cv2.cvtColor(convert_to_uint8(img), cv2.COLOR_BGR2LAB)
            l = lab[:, :, 0] / 255.0
            sm = np.exp(-((l - 0.25)**2) / 0.08); hm = np.exp(-((l - 0.75)**2) / 0.08)
            l_adj = l.copy()
            if s != 0: l_adj += sm * s
            if h != 0: l_adj += hm * h
            lab[:, :, 0] = np.clip(l_adj, 0, 1) * 255
            return convert_to_float(cv2.cvtColor(lab, cv2.COLOR_LAB2BGR))
        def apply_clahe(img, cl, tgs):
            lab = cv2.cvtColor(convert_to_uint8(img), cv2.COLOR_BGR2LAB)
            clahe = cv2.createCLAHE(clipLimit=cl, tileGridSize=tgs)
            lab[:,:,0] = clahe.apply(lab[:,:,0])
            return convert_to_float(cv2.cvtColor(lab, cv2.COLOR_LAB2BGR))
        def apply_s_curve(img, cp):
            xs = np.array([p[0] for p in cp]); ys = np.array([p[1] for p in cp])
            spline = CubicSpline(xs, ys, extrapolate=True)
            hsv = cv2.cvtColor(convert_to_uint8(img), cv2.COLOR_BGR2HSV)
            v = hsv[:, :, 2] / 255.0
            v_curved = np.clip(spline(v), 0, 1) * 255
            hsv[:, :, 2] = v_curved.astype(np.uint8)
            return convert_to_float(cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR))
        def adjust_vibrance_saturation(img, v, s):
            hsv = cv2.cvtColor(convert_to_uint8(img), cv2.COLOR_BGR2HSV)
            sat = hsv[:, :, 1].astype(np.float32) / 255.0
            if v != 0: sat += sat * (1 - sat) * v
            if s != 1.0: sat *= s
            hsv[:, :, 1] = np.clip(sat * 255, 0, 255)
            return convert_to_float(cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR))
        def unsharp_mask(img, a, r, t):
            if a == 0: return img
            img_uint8 = convert_to_uint8(img)
            blur = cv2.GaussianBlur(img_uint8, (0, 0), r)
            sharp = cv2.addWeighted(img_uint8, 1 + a, blur, -a, 0)
            return convert_to_float(sharp)
        def apply_glow(img, strength, radius, threshold):
            img_uint8 = convert_to_uint8(img)
            gray = cv2.cvtColor(img_uint8, cv2.COLOR_BGR2GRAY)
            _, bright_pass = cv2.threshold(gray, int(threshold), 255, cv2.THRESH_BINARY)
            kernel_size = int(radius)
            if kernel_size % 2 == 0: kernel_size += 1
            blurred_glow = cv2.GaussianBlur(bright_pass, (kernel_size, kernel_size), 0)
            glow_map = cv2.cvtColor(blurred_glow, cv2.COLOR_GRAY2BGR)
            return cv2.addWeighted(img, 1.0, convert_to_float(glow_map), strength, 0)
        def apply_vignette(img, s):
            rows, cols = img.shape[:2]; s = 1.01 - s
            kx = cv2.getGaussianKernel(cols, cols*s); ky = cv2.getGaussianKernel(rows, rows*s)
            mask = ky * kx.T; mask /= np.max(mask)
            for i in range(3): img[:,:,i] *= mask
            return img

        class Editor:
            def __init__(self, image_urls):
                self.image_urls = image_urls; self.original_images = {}
            async def load_images(self):
                gallery = document.getElementById("gallery"); gallery.innerHTML = ""
                header_before = document.createElement("div"); header_before.className = "gallery-header"; header_before.textContent = "Before"
                header_after = document.createElement("div"); header_after.className = "gallery-header"; header_after.textContent = "After"
                gallery.appendChild(header_before); gallery.appendChild(header_after)
                for i, url in enumerate(self.image_urls):
                    try:
                        res = await pyfetch(url); img_bytes = await res.bytes()
                        img_np = cv2.imdecode(np.frombuffer(img_bytes, np.uint8), cv2.IMREAD_COLOR)
                        self.original_images[i] = img_np
                        before_div = document.createElement("div"); before_div.className = "gallery-image-container"; before_div.innerHTML = f'<img id="before-{i}" src="{url}">'
                        after_div = document.createElement("div"); after_div.className = "gallery-image-container"; after_div.innerHTML = f'<img id="after-{i}" src="{url}">'
                        gallery.appendChild(before_div); gallery.appendChild(after_div)
                    except Exception as e: print(f"Error loading image {url}: {e}")
            
            def get_params(self):
                params = {}
                ids = ["TEMPERATURE", "TINT", "EXPOSURE", "CONTRAST", "SHADOWS", "HIGHLIGHTS", "CLAHE_CLIP_LIMIT", "VIBRANCE", "SATURATION", "SHARPEN_AMOUNT", "SHARPEN_RADIUS_RELATIVE", "VIGNETTE_STRENGTH", "GLOW_STRENGTH", "GLOW_RADIUS", "GLOW_THRESHOLD"]
                for id in ids: params[id] = float(document.getElementById(id).value)
                svg_data = js.document.getElementById("tone-curve-svg").dataset
                p1 = [float(svg_data.p1x), float(svg_data.p1y)]; p2 = [float(svg_data.p2x), float(svg_data.p2y)]; p3 = [float(svg_data.p3x), float(svg_data.p3y)]
                middle_points = sorted([p1, p2, p3], key=lambda p: p[0])
                params['TONE_CURVE_POINTS'] = [[0,0], middle_points[0], middle_points[1], middle_points[2], [1,1]]
                return params
            
            def process_and_update(self, event=None):
                apply_btn = document.getElementById("apply-button")
                apply_btn.textContent = "Processing..."; apply_btn.disabled = True
                try:
                    params = self.get_params()
                    for i, img_original in self.original_images.items():
                        img_f = convert_to_float(img_original)
                        img_f = adjust_temp_tint(img_f, params['TEMPERATURE'], params['TINT'])
                        img_f = adjust_exposure_contrast(img_f, params['EXPOSURE'], params['CONTRAST'])
                        img_f = adjust_tonal_ranges(img_f, params['SHADOWS'], params['HIGHLIGHTS'])
                        if params['CLAHE_CLIP_LIMIT'] > 0: img_f = apply_clahe(img_f, params['CLAHE_CLIP_LIMIT'], (8,8))
                        img_f = apply_s_curve(img_f, params['TONE_CURVE_POINTS'])
                        img_f = adjust_vibrance_saturation(img_f, params['VIBRANCE'], params['SATURATION'])
                        h, w = img_f.shape[:2]
                        radius = max(0.5, params['SHARPEN_RADIUS_RELATIVE'] * (w / 1920.0))
                        img_f = unsharp_mask(img_f, params['SHARPEN_AMOUNT'], radius, 0)
                        if params['GLOW_STRENGTH'] > 0: img_f = apply_glow(img_f, params['GLOW_STRENGTH'], params['GLOW_RADIUS'], params['GLOW_THRESHOLD'])
                        if params['VIGNETTE_STRENGTH'] > 0: img_f = apply_vignette(img_f, params['VIGNETTE_STRENGTH'])
                        _, buffer = cv2.imencode('.jpg', convert_to_uint8(img_f))
                        b64 = base64.b64encode(buffer).decode('utf-8')
                        document.getElementById(f"after-{i}").src = f"data:image/jpeg;base64,{b64}"
                finally:
                    apply_btn.textContent = "Apply Changes"; apply_btn.disabled = False

        async def main():
            image_urls = [ "https://raw.githubusercontent.com/TitanStar73/TitanStar73.github.io/main/imgs/img1.png", "https://raw.githubusercontent.com/TitanStar73/TitanStar73.github.io/main/imgs/img2.png", "https://raw.githubusercontent.com/TitanStar73/TitanStar73.github.io/main/imgs/img3.png", "https://raw.githubusercontent.com/TitanStar73/TitanStar73.github.io/main/imgs/img4.png" ]
            editor = Editor(image_urls)
            document.getElementById("loader-text").textContent = "Loading Images..."
            await editor.load_images()

            document.getElementById("loader-text").style.display = "none"
            document.getElementById("fullscreen-btn").style.display = "block"
            
            proxy_update_func = create_proxy(editor.process_and_update)
            document.getElementById("apply-button").addEventListener("click", proxy_update_func)
            editor.process_and_update()

        asyncio.ensure_future(main())
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Robust Fullscreen Logic ---
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const loader = document.getElementById('loader');
            function openFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) { elem.requestFullscreen(); } 
                else if (elem.webkitRequestFullscreen) { /* Safari */ elem.webkitRequestFullscreen(); } 
                else if (elem.msRequestFullscreen) { /* IE11 */ elem.msRequestFullscreen(); }
            }
            fullscreenBtn.addEventListener('click', openFullscreen);
            function handleFullscreenChange() {
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    loader.classList.add('hidden');
                }
            }
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);


            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const display = document.getElementById(slider.id + '_val');
                if (display) slider.addEventListener('input', () => display.textContent = slider.value);
            });

            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('controls-panel');
            let isResizing = false;
            resizer.addEventListener('mousedown', () => isResizing = true);
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const newWidth = e.clientX;
                const minWidth = parseInt(getComputedStyle(leftPanel).minWidth);
                const maxWidth = parseInt(getComputedStyle(leftPanel).maxWidth);
                if (newWidth > minWidth && newWidth < maxWidth) { leftPanel.style.width = `${newWidth}px`; }
            });
            document.addEventListener('mouseup', () => isResizing = false);

            const svg = document.getElementById('tone-curve-svg');
            let width = svg.clientWidth || 240; let height = svg.clientHeight || 150;
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('fill', 'none'); line.setAttribute('stroke', '#007bff'); line.setAttribute('stroke-width', '2');
            svg.appendChild(line);
            let controlPoints = [
                { x: 0, y: height }, { x: width * 0.25, y: height * 0.75 }, { x: width * 0.5, y: height * 0.5 },
                { x: width * 0.75, y: height * 0.25 }, { x: width, y: 0 }
            ];
            const createDraggablePoint = (point, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x); circle.setAttribute('cy', point.y); circle.setAttribute('r', '8');
                circle.setAttribute('fill', 'white'); circle.setAttribute('cursor', 'grab');
                svg.appendChild(circle);

                let isDragging = false;
                const startDrag = (e) => { isDragging = true; circle.setAttribute('cursor', 'grabbing'); e.preventDefault(); };
                const endDrag = () => { isDragging = false; circle.setAttribute('cursor', 'grab'); };
                const drag = (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        const rect = svg.getBoundingClientRect();
                        const x = e.clientX || e.touches[0].clientX;
                        const y = e.clientY || e.touches[0].clientY;
                        let newX = Math.max(0, Math.min(width, x - rect.left));
                        let newY = Math.max(0, Math.min(height, y - rect.top));
                        controlPoints[index].x = newX; controlPoints[index].y = newY;
                        circle.setAttribute('cx', newX); circle.setAttribute('cy', newY);
                        updateCurve();
                    }
                };

                circle.addEventListener('mousedown', startDrag);
                svg.addEventListener('mousemove', drag);
                svg.addEventListener('mouseup', endDrag);
                svg.addEventListener('mouseleave', endDrag);

                circle.addEventListener('touchstart', startDrag, { passive: false });
                svg.addEventListener('touchmove', drag, { passive: false });
                svg.addEventListener('touchend', endDrag);
            };
            const getCurvePath = (points, tension = 0.5) => {
                let d = `M ${points[0].x} ${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    let p0 = (i > 0) ? points[i - 1] : points[i]; let p1 = points[i];
                    let p2 = points[i + 1]; let p3 = (i < points.length - 2) ? points[i + 2] : p2;
                    let cp1x = p1.x + (p2.x - p0.x) / 6 * tension; let cp1y = p1.y + (p2.y - p0.y) / 6 * tension;
                    let cp2x = p2.x - (p3.x - p1.x) / 6 * tension; let cp2y = p2.y - (p3.y - p1.y) / 6 * tension;
                    d += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`;
                } return d;
            };
            const updateCurve = () => {
                line.setAttribute('d', getCurvePath(controlPoints, 1.0));
                const midPoints = controlPoints.slice(1, 4);
                svg.dataset.p1x = (midPoints[0].x / width).toFixed(3); svg.dataset.p1y = (1 - (midPoints[0].y / height)).toFixed(3);
                svg.dataset.p2x = (midPoints[1].x / width).toFixed(3); svg.dataset.p2y = (1 - (midPoints[1].y / height)).toFixed(3);
                svg.dataset.p3x = (midPoints[2].x / width).toFixed(3); svg.dataset.p3y = (1 - (midPoints[2].y / height)).toFixed(3);
            };
            createDraggablePoint(controlPoints[1], 1); createDraggablePoint(controlPoints[2], 2); createDraggablePoint(controlPoints[3], 3);
            updateCurve();
        });
    </script>
</body>
</html>
